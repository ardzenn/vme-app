<div class="chat-widget-toggler" id="chat-widget-toggler">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
    <span class="badge bg-danger rounded-pill position-absolute top-0 start-100 translate-middle" id="widget-unread-badge" style="display: none; border: 2px solid white;"></span>
</div>

<div class="chat-widget-container" id="chat-widget-container">
    <div class="widget-view" id="widget-list-view">
        <div class="widget-header">
            <h4>Messenger</h4>
            <div>
                <button class="btn btn-sm btn-light rounded-circle" data-bs-toggle="modal" data-bs-target="#createGroupModal" title="Create Group"><i class="fas fa-users"></i></button>
                <button class="btn btn-sm btn-light rounded-circle" id="chat-widget-close" title="Close"><i class="fas fa-times"></i></button>
            </div>
        </div>
        
        <ul class="nav nav-tabs nav-fill px-2">
            <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#tab-chats">Chats</a></li>
            <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-groups">Groups</a></li>
            <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tab-users">Users</a></li>
        </ul>

        <div class="tab-content flex-grow-1" style="overflow-y: auto;">
            <div class="tab-pane fade show active" id="tab-chats">
                <div class="p-2 border-bottom"><input type="text" id="chat-search-input" class="form-control form-control-sm" placeholder="Search all chats..."></div>
                <div class="widget-list-body" id="conversation-list-body"></div>
            </div>
            <div class="tab-pane fade" id="tab-groups">
                <div class="p-2 border-bottom"><input type="text" id="group-search-input" class="form-control form-control-sm" placeholder="Search groups..."></div>
                <div class="widget-list-body" id="group-list-body"></div>
            </div>
            <div class="tab-pane fade" id="tab-users">
                <div class="p-2 border-bottom"><input type="text" id="user-search-input" class="form-control form-control-sm" placeholder="Search users..."></div>
                <div class="widget-list-body" id="user-list-body"></div>
            </div>
        </div>
    </div>

    <div class="widget-view" id="widget-chat-view">
        <div class="widget-header">
            <button class="btn btn-sm btn-light rounded-circle me-2" id="chat-back-btn" title="Back"><i class="fas fa-arrow-left"></i></button>
            <div id="chat-header-info" class="d-flex align-items-center me-auto" style="cursor: pointer;">
                <img id="widget-recipient-pic" src="" class="rounded-circle" width="40" height="40">
                <h5 id="widget-recipient-name" class="mb-0 ms-2"></h5>
            </div>
            <a href="#" target="_blank" class="btn btn-sm btn-light rounded-circle" id="maximize-chat-btn" title="Open in full page"><i class="fas fa-expand-alt"></i></a>
            <div id="manage-group-button-container" class="ms-1"></div>
        </div>
        <div id="widget-chat-messages" class="chat-messages flex-grow-1 p-3"></div>
        <div id="typing-indicator" class="p-2 text-muted small" style="display: none; height: 30px; font-style: italic;"></div>
        <form id="widget-message-form" class="chat-input-area p-3 border-top bg-light">
            <div class="input-group">
                <input type="text" id="widget-message-input" class="form-control" placeholder="Type a message..." autocomplete="off">
                <button type="submit" class="btn btn-primary">Send</button>
            </div>
        </form>
    </div>
</div>


<div class="modal fade" id="createGroupModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title">Create Group Chat</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <form id="createGroupForm">
          <div class="mb-3"><label class="form-label">Group Name</label><input type="text" id="groupName" class="form-control" required></div>
          <div class="mb-3"><label class="form-label">Select Participants</label>
            <div style="max-height: 200px; overflow-y: auto; border: 1px solid #ccc; padding: 10px;" id="group-participants-list-modal">
                </div>
          </div>
          <button type="submit" class="btn btn-primary w-100">Create Group</button>
        </form>
       </div>
    </div>
  </div>
</div>

<div class="modal fade" id="groupInfoModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="groupInfoModalTitle">Group Members</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p><strong id="group-member-count"></strong> members</p>
        <ul class="list-group" id="group-participant-list-modal-view"></ul>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="removeParticipantModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title">Remove Participant</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <p>Select a participant to remove from the group.</p>
        <div id="remove-participant-list" class="list-group"></div>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="deleteGroupModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title text-danger">Delete Group</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <p>Are you sure you want to permanently delete this group? This action cannot be undone.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="confirm-delete-group-btn">Delete Group</button>
      </div>
    </div>
  </div>
</div>
<div class="chat-widget-toggler" id="chat-widget-toggler">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
    <span class="badge bg-danger rounded-pill position-absolute top-0 start-100 translate-middle" id="widget-unread-badge" style="display: none; border: 2px solid white;"></span>
</div>

<div class="chat-widget-container" id="chat-widget-container">
    
    <div class="conversation-list" id="widget-list-view">
        <div class="conversation-list-header d-flex justify-content-between align-items-center">
            <h4>Messenger</h4>
            <div>
                <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#createGroupModal" title="Create Group">+</button>
                <button class="btn-close" id="chat-widget-close"></button>
            </div>
        </div>
        
        <ul class="nav nav-tabs nav-fill">
            <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#conversations-tab-panel">Chats</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#groups-tab-panel">Groups</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#users-tab-panel">Users</button></li>
        </ul>

        <div class="tab-content">
            <div class="tab-pane fade show active" id="conversations-tab-panel">
                <div class="p-2 border-bottom">
                    <input type="text" id="chat-search-input" class="form-control form-control-sm" placeholder="Search all chats...">
                </div>
                <div class="conversation-list-body" id="conversation-list-body"></div>
            </div>
            <div class="tab-pane fade" id="groups-tab-panel">
                <div class="p-2 border-bottom">
                    <input type="text" id="group-search-input" class="form-control form-control-sm" placeholder="Search groups...">
                </div>
                <div class="conversation-list-body" id="group-list-body"></div>
            </div>
            <div class="tab-pane fade" id="users-tab-panel">
                <div class="p-2 border-bottom">
                    <input type="text" id="user-search-input" class="form-control form-control-sm" placeholder="Search users...">
                </div>
                <div id="user-list-body" class="conversation-list-body">
                    <% if(locals.conversations) { conversations.forEach(user => { %>
                        <div class="conversation new-chat-user" data-name="<%= (user.firstName || '').toLowerCase() %> <%= (user.lastName || '').toLowerCase() %>" data-recipient-id="<%= user._id %>">
                            <img src="<%= user.profilePicture %>" alt="<%= user.firstName %>">
                            <div><strong><%= user.firstName %> <%= user.lastName %></strong></div>
                        </div>
                    <% }); } %>
                </div>
            </div>
        </div>
    </div>

    <div class="chat-window" id="widget-chat-window">
        <div class="chat-window-header" id="widget-chat-header">
            <button class="btn btn-sm btn-light me-2" id="chat-back-btn">&lt;</button>
            <div id="chat-header-info" class="d-flex align-items-center me-auto">
                <img id="widget-recipient-pic" src="">
                <h5 id="widget-recipient-name" class="mb-0 ms-2"></h5>
            </div>
            <div id="manage-group-button-container"></div>
        </div>
        <div id="widget-chat-messages" class="chat-messages flex-grow-1 p-3"></div>
        <div id="typing-indicator" class="p-2 text-muted small" style="display: none; height: 30px; font-style: italic;"></div>
        <div class="chat-input-area p-3 border-top bg-light">
            <form id="widget-message-form">
                <div class="input-group">
                    <input type="text" id="widget-message-input" class="form-control" placeholder="Type a message..." autocomplete="off">
                    <button type="submit" class="btn btn-primary">Send</button>
                </div>
            </form>
        </div>
    </div>

    <div class="chat-window" id="widget-group-info-view">
        <div class="chat-window-header">
            <button class="btn btn-sm btn-light me-2" id="info-back-btn">&lt;</button>
            <h5 class="mb-0">Group Members</h5>
        </div>
        <div id="group-participant-list" class="conversation-list-body"></div>
    </div>
</div>

<div class="modal fade" id="createGroupModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title">Create Group Chat</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <form id="createGroupForm">
          <div class="mb-3"><label class="form-label">Group Name</label><input type="text" id="groupName" class="form-control" required></div>
          <div class="mb-3"><label class="form-label">Select Participants</label>
            <div style="max-height: 200px; overflow-y: auto; border: 1px solid #ccc; padding: 10px;" id="group-participants-list-modal">
                <% if(locals.conversations) { conversations.forEach(user => { %>
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" name="participants" value="<%= user._id %>" id="modal-user-<%= user._id %>">
                      <label class="form-check-label" for="modal-user-<%= user._id %>"><%= user.firstName %> <%= user.lastName %></label>
                    </div>
                <% }); } %>
            </div>
          </div>
          <button type="submit" class="btn btn-primary w-100">Create Group</button>
        </form>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="removeParticipantModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title">Remove Participant</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <p>Select a participant to remove from the group.</p>
        <div id="remove-participant-list" class="list-group"></div>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="deleteGroupModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title">Delete Group</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <p>Are you sure you want to permanently delete this group? This action cannot be undone.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="confirm-delete-group-btn">Delete Group</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="groupInfoModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="groupInfoModalTitle">Group Members</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p><strong id="group-member-count"></strong> members</p>
        <ul class="list-group" id="group-participant-list-modal-view"></ul>
      </div>
    </div>
  </div>
</div>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Order Invoice</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/style.css">
  <script src="/socket.io/socket.io.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
  <div class="container">
    <h1>Order for <%= order.customerName %></h1>
    <div id="chat" style="max-height: 300px; overflow-y: auto;">
      <% messages.forEach(msg => { %>
        <p><strong><%= msg.user.username %>:</strong> <%= msg.text %> <% if (msg.attachment) { %><img src="<%= msg.attachment %>" width="100"><% } %></p>
      <% }) %>
    </div>
    <div class="card mt-4 invoice-section">
      <div class="card-body">
        <h1>Invoice for Order <%= order.reference %></h1>
        <p>Hospital: <%= order.hospital %></p>
        <p>Customer Name: <%= order.customerName %></p>
        <p>Address: <%= order.area %></p>
        <p>MSR/KAS Name: <%= order.user.username %></p>
        <p>Status: <%= order.status %></p>
        <table class="table">
          <thead>
            <tr>
              <th>Product</th>
              <th>Quantity</th>
              <th>Price</th>
              <th>Amount</th>
            </tr>
          </thead>
          <tbody>
            <% order.products.forEach(p => { %>
              <tr>
                <td><%= p.product %></td>
                <td><%= p.quantity %></td>
                <td><%= p.price %></td>
                <td><%= p.total %></td>
              </tr>
            <% }) %>
            <tr>
              <td colspan="3">Subtotal</td>
              <td><%= order.subtotal %></td>
            </tr>
          </tbody>
        </table>
        <p>Reference Number: <%= order.reference %></p>
        <% if (user.role === 'Accounting' ) { %>
          <form action="/order/<%= order._id %>/update" method="POST">
            <label>Sales Invoice Number</label>
            <input type="text" name="salesInvoice" value="<%= order.salesInvoice || '' %>" class="form-control">
            <label>Status</label>
            <select name="status" class="form-control">
              <option value="Pending" <%= order.status === 'Pending' ? 'selected' : '' %>>Pending</option>
              <option value="Processed" <%= order.status === 'Processed' ? 'selected' : '' %>>Processed</option>
            </select>
            <button type="submit" class="btn btn-primary mt-2">Update</button>
          </form>
        <% } else { %>
          <p>Sales Invoice Number: <%= order.salesInvoice || 'Pending' %></p>
        <% } %>
      </div>
    </div>
    <div class="card mt-4">
      <div class="card-body">
        <h2>Communication</h2>
        <input type="text" id="chat-search" class="form-control mb-2" placeholder="Search messages">
        <div id="chat-messages">
          <% messages.forEach(msg => { %>
            <p data-text="<%= msg.text %>"><strong><%= msg.user.username %>:</strong> <%= msg.text %> <% if (msg.attachment) { %><img src="<%= msg.attachment %>" width="100"><% } %></p>
          <% }) %>
        </div>
        <form id="messageForm">
          <input type="text" id="text" name="text" placeholder="Message" class="form-control">
          <input type="file" id="attachment" name="attachment" class="mt-2">
          <button type="submit" class="btn btn-primary mt-2">Send</button>
        </form>
      </div>
    </div>
  </div>
  <script>
    const socket = io();
    socket.emit('joinOrder', '<%= order._id %>');
    document.getElementById('messageForm').addEventListener('submit', async e => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const res = await fetch('/order/<%= order._id %>/message', { method: 'POST', body: formData });
      if (res.ok) {
        document.getElementById('text').value = '';
        document.getElementById('attachment').value = '';
      }
    });
    socket.on('newMessage', msg => {
      const p = document.createElement('p');
      p.innerHTML = `<strong>${msg.user.username}:</strong> ${msg.text || ''} ${msg.attachment ? '<img src="' + msg.attachment + '" width="100">' : ''}`;
      p.dataset.text = msg.text;
      document.getElementById('chat-messages').appendChild(p);
    });

    // Chat search
    document.getElementById('chat-search').addEventListener('input', e => {
      const filter = e.target.value.toLowerCase();
      Array.from(document.getElementById('chat-messages').children).forEach(p => {
        p.style.display = p.dataset.text.toLowerCase().includes(filter) ? 'block' : 'none';
      });
    });
  </script>
</body>
</html>
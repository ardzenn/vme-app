<!DOCTYPE html>
<html lang="en">
<head>
    <title>Dashboard - VME App</title>
    <%- include('partials/header-meta') %>
</head>
<body data-user-id="<%= currentUser._id %>" data-current-user='<%- JSON.stringify(currentUser) %>'>
    <%- include('partials/navbar') %>

    <main class="container-fluid" style="padding: 0 2rem;">
        <header class="page-header">
    <div>
        <h1 style="font-size: 1.875rem;">Dashboard</h1>
        <p style="margin: 0;">Welcome back, <%= currentUser.firstName %>!</p>
    </div>
    <div class="header-actions">
        <a href="/transactions/my-submissions" class="btn btn-secondary dashboard-header-btn">Collections</a>
        <a href="/manage-entries" class="btn btn-secondary dashboard-header-btn">Manage My Entries</a>
        <a href="/products" class="btn btn-dark dashboard-header-btn">Product Gallery</a>
        <a href="/planning/my-plans" class="btn btn-info text-white dashboard-header-btn">Itinerary</a>
        <a href="/report" class="btn btn-success dashboard-header-btn">Daily Coverage Report</a>
        <a href="/bookorder" class="btn btn-primary dashboard-header-btn">Book New Order</a>
        <button type="button" class="btn btn-primary dashboard-header-btn" data-bs-toggle="modal" data-bs-target="#checkinModal">
            Check-in
        </button>
    </div>
</header>

        <% if (locals.success_msg && success_msg.length > 0) { %><div class="alert alert-success"><%= success_msg %></div><% } %>
        <% if (locals.error_msg && error_msg.length > 0) { %><div class="alert alert-danger"><%= error_msg %></div><% } %>

        <div class="row g-4 mb-4">
            <div class="col-lg-4"><div class="card stat-card"><div class="stat-title">Check-ins Today</div><div class="stat-value"><%= stats.checkinsToday %></div></div></div>
            <div class="col-lg-4"><div class="card stat-card"><div class="stat-title">Pending Orders</div><div class="stat-value"><%= stats.pendingOrders %></div></div></div>
            <div class="col-lg-4"><div class="card stat-card"><div class="stat-title">Total Sales</div><div class="stat-value"><%= stats.totalSales %></div></div></div>
        </div>

        <ul class="nav nav-tabs mb-3" id="dashboardTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="orders-tab" data-bs-toggle="tab" data-bs-target="#orders-panel" type="button" role="tab">My Sales Orders</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="checkins-tab" data-bs-toggle="tab" data-bs-target="#checkins-panel" type="button" role="tab">My Check-in History</button>
            </li>
        </ul>

        <div class="tab-content" id="dashboardTabContent">
            <div class="tab-pane fade show active" id="orders-panel" role="tabpanel">
                <div class="card card-tab">
                    <div class="card-body">
                        <input type="text" id="orderSearch" class="form-control mb-3" placeholder="Search your sales orders...">
                        <div class="table-responsive">
                            <table class="table table-hover" id="orderTable">
                                <thead><tr><th>Reference</th><th>Customer</th><th>Status</th><th>Date</th><th>Actions</th></tr></thead>
                                <tbody>
                                    <% if(orders.length > 0) { %>
                                        <% orders.forEach(order => { %>
                                            <tr data-search="<%= (order.reference || '').toLowerCase() %> <%= (order.customerName || '').toLowerCase() %> <%= (order.status || '').toLowerCase() %>">
                                                <td><%= order.reference || 'N/A' %></td>
                                                <td><%= order.customerName || 'N/A' %></td>
                                                <td><span class="badge bg-primary"><%= order.status || 'N/A' %></span></td>
                                                <td><%= new Date(order.createdAt).toLocaleDateString() %></td>
                                                <td><button class="btn btn-sm btn-outline-primary view-order-btn" data-order-id="<%= order._id %>">View</button></td>
                                            </tr>
                                        <% }) %>
                                    <% } else { %>
                                        <tr><td colspan="5" class="text-center p-4">No sales orders found.</td></tr>
                                    <% } %>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>      
                        

            <div class="tab-pane fade" id="checkins-panel" role="tabpanel">
               <div class="card card-tab">
                    <div class="card-body">
                        <input type="text" id="checkinSearch" class="form-control mb-3" placeholder="Search your check-ins...">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle" id="checkinTable">
                                <thead>
                                    <tr>
                                        <th>Hospital</th>
                                        <th>Doctor</th>
                                        <th>Activity</th>
                                      
                                        <th>Proof</th>
                                        <th>Signature</th>
                                        <th>Date</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% if(checkins.length > 0) { %>
                                        <% checkins.forEach(checkin => { %>
                                            <tr data-search="<%= (checkin.hospital ? checkin.hospital.name : '').toLowerCase() %> <%= (checkin.doctor ? checkin.doctor.name : '').toLowerCase() %>">
                                                <td><%= checkin.hospital ? checkin.hospital.name : 'N/A' %></td>
                                                <td><%= checkin.doctor ? checkin.doctor.name : 'N/A' %></td>
                                                <td><%= checkin.activity || 'N/A' %></td>
                                                <td>
                                                    <% if (checkin.proof) { %>
                                                        <img src="<%= checkin.proof %>" alt="Proof" width="70" style="border-radius: 0.25rem; cursor: pointer;" onclick="showImageInModal('<%= checkin.proof %>')">
                                                    <% } else { %><span class="text-muted">No Proof</span><% } %>
                                                </td>
                                                <td>
                                                    <% if (checkin.signature) { %>
                                                        <img src="<%= checkin.signature %>" alt="Signature" width="70" style="background-color: #fafafa; border-radius: 0.25rem; cursor: pointer;" onclick="showImageInModal('<%= checkin.signature %>')">
                                                    <% } else { %><span class="text-muted">No Signature</span><% } %>
                                                </td>
                                                <td><%= new Date(checkin.createdAt).toLocaleString() %></td>
                                            </tr>
                                        <% }) %>
                                    <% } else { %>
                                        <tr><td colspan="7" class="text-center p-4">No check-in history found.</td></tr>
                                    <% } %>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <%- include('partials/checkin-modal.ejs') %>
    <%- include('partials/order-detail-modal.ejs') %>
    <%- include('partials/image-zoom-modal.ejs') %>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="/js/dashboard-main.js"></script>
    <script src="/js/push-client.js"></script>
    <script>
        const imageZoomModal = new bootstrap.Modal(document.getElementById('imageZoomModal'));
        const modalZoomImage = document.getElementById('modalZoomImage');
        function showImageInModal(src) {
            if (modalZoomImage) {
                modalZoomImage.src = src;
                imageZoomModal.show();
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            // Table search functionality
            const addTableFilter = (inputId, tableId) => {
                const searchInput = document.getElementById(inputId);
                if (searchInput) {
                    searchInput.addEventListener('input', (e) => {
                        const searchTerm = e.target.value.toLowerCase();
                        document.querySelectorAll(`#${tableId} tbody tr`).forEach(row => {
                            row.style.display = (row.dataset.search || '').includes(searchTerm) ? '' : 'none';
                        });
                    });
                }
            };
            addTableFilter('orderSearch', 'orderTable');
            addTableFilter('checkinSearch', 'checkinTable');

            // Service Worker Registration
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('/sw.js')
                        .then(registration => {
                            console.log('Service Worker registered successfully:', registration);
                        })
                        .catch(error => {
                            console.log('Service Worker registration failed:', error);
                        });
                });
            }
        });
    </script>
    <%- include('partials/chat-widget.ejs') %>
    <script src="/js/chat-widget.js"></script>
</body>
</html>
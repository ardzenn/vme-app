<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Call Plan - VME App</title>
    <%- include('partials/header-meta') %>
    <style>
        .card-body h5 {
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }
        .list-group-item {
            display: flex;
            align-items: center;
        }
        .list-group-item .content {
            flex-grow: 1;
        }
    </style>
</head>
<body>
    <%- include('partials/navbar') %>

    <main class="container my-5" style="max-width: 800px;">
        <header class="page-header">
            <div>
                <h1>Daily Call Plan</h1>
                <p class="text-muted">Outline your objectives and targets for the day.</p>
            </div>
        </header>

        <div id="notification-area"></div>

        <% if (locals.error_msg && error_msg.length > 0) { %>
            <div class="alert alert-danger"><%= error_msg %></div>
        <% } %>

        <form id="dailyPlanForm">
            <input type="hidden" name="planId" value="<%= typeof plan !== 'undefined' && plan._id ? plan._id : '' %>">
            <div class="card">
                <div class="card-body">
                    <div class="mb-3">
                        <label for="planDate" class="form-label">Plan Date</label>
                        <input type="date" id="planDate" name="planDate" class="form-control" value="<%= planDate %>" required>
                    </div>
                    <div class="mb-3">
                        <label for="firstClientCall" class="form-label">First Client Call</label>
                        <input type="text" id="firstClientCall" name="firstClientCall" class="form-control" placeholder="e.g., Davao City Hall" value="<%= plan.firstClientCall || '' %>">
                    </div>
                    <div class="mb-4">
                        <label for="areasToVisit" class="form-label">Areas to Visit Today</label>
                        <input type="text" id="areasToVisit" name="areasToVisit" class="form-control" placeholder="e.g., Digos, Davao del Sur" value="<%= plan.areasToVisit || '' %>">
                    </div>

                    <h5 class="mt-4">1. Hospitals & Capitol to Visit</h5>
                    <div id="itinerary-container">
                        <% if (plan.itinerary) { %>
                            <% plan.itinerary.forEach((item, index) => { %>
                                <div class="input-group mb-2">
                                    <span class="input-group-text"><%= index + 1 %>.</span>
                                    <input type="text" class="form-control" placeholder="Place Name" value="<%= item %>">
                                    <button class="btn btn-outline-danger remove-item-btn" type="button">X</button>
                                </div>
                            <% }) %>
                        <% } %>
                    </div>
                    <div class="input-group">
                        <input type="text" id="itinerary-input" class="form-control" placeholder="Enter Place Name...">
                        <button type="button" class="btn btn-outline-primary add-item-btn" data-target="itinerary-container" data-input="itinerary-input">+ Add Place</button>
                    </div>


                    <h5 class="mt-4">2. Sales Objectives for the Day</h5>
                    <div id="sales-objectives-container">
                        <% if (plan.salesObjectives) { %>
                            <% plan.salesObjectives.forEach((obj, index) => { %>
                            <div class="input-group mb-2">
                                <input type="text" class="form-control" placeholder="Objective description" value="<%= obj.objective %>">
                                 <button class="btn btn-outline-danger remove-item-btn" type="button">X</button>
                            </div>
                            <% }) %>
                        <% } %>
                    </div>
                    <div class="input-group">
                        <input type="text" id="sales-objective-input" class="form-control" placeholder="Enter Objective...">
                        <button type="button" class="btn btn-outline-primary add-item-btn" data-target="sales-objectives-container" data-input="sales-objective-input">+ Add Objective</button>
                    </div>


                    <h5 class="mt-4">3. Target Collections for the Day (90 Days and Below)</h5>
                    <div id="current-collections-container">
                        <% if (plan.targetCollections && plan.targetCollections.current) { %>
                            <% plan.targetCollections.current.forEach((col, index) => { %>
                            <div class="input-group mb-2 collection-item" data-client="<%= col.client %>" data-amount="<%= col.amount %>">
                                <input type="text" class="form-control" placeholder="Client Name" value="<%= col.client %>" disabled>
                                <span class="input-group-text">₱</span>
                                <input type="number" class="form-control" placeholder="Amount" value="<%= col.amount %>" step="0.01" disabled>
                                <button class="btn btn-outline-danger remove-item-btn" type="button">X</button>
                            </div>
                            <% }) %>
                        <% } %>
                    </div>
                    <div class="input-group">
                        <input type="text" id="current-collection-client" class="form-control" placeholder="Client Name">
                        <span class="input-group-text">₱</span>
                        <input type="number" id="current-collection-amount" class="form-control" placeholder="Amount" step="0.01">
                        <button type="button" id="add-current-collection-btn" class="btn btn-outline-primary">+ Add Target</button>
                    </div>


                    <h5 class="mt-4">4. Target Collections for Overdue Accounts</h5>
                    <div id="overdue-collections-container">
                         <% if (plan.targetCollections && plan.targetCollections.overdue) { %>
                             <% plan.targetCollections.overdue.forEach((col, index) => { %>
                             <div class="card bg-light p-3 mb-2 overdue-collection-item" data-client="<%= col.client %>" data-si="<%= col.siDrNumber %>" data-date="<%= col.date ? new Date(col.date).toISOString().split('T')[0] : '' %>" data-amount="<%= col.amount %>">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h6>Overdue Target</h6>
                                    <button class="btn btn-sm btn-danger remove-item-btn" type="button">Remove</button>
                                </div>
                                <input type="text" class="form-control mb-2" placeholder="Client Name" value="<%= col.client %>" disabled>
                                <input type="text" class="form-control mb-2" placeholder="SI / DR Number" value="<%= col.siDrNumber %>" disabled>
                                <input type="date" class="form-control mb-2" value="<%= col.date ? new Date(col.date).toISOString().split('T')[0] : '' %>" disabled>
                                <input type="number" class="form-control" placeholder="Amount" value="<%= col.amount %>" step="0.01" disabled>
                             </div>
                             <% }) %>
                         <% } %>
                    </div>
                    <div class="card bg-light p-3">
                        <input type="text" id="overdue-client" class="form-control mb-2" placeholder="Client Name">
                        <input type="text" id="overdue-si" class="form-control mb-2" placeholder="SI / DR Number">
                        <input type="date" id="overdue-date" class="form-control mb-2">
                        <input type="number" id="overdue-amount" class="form-control" placeholder="Amount" step="0.01">
                        <button type="button" id="add-overdue-collection-btn" class="btn btn-primary mt-2">+ Add Overdue Target</button>
                    </div>
                </div>

                <div class="card-footer text-end">
                    <a href="/planning/my-plans" class="btn btn-secondary">Cancel</a>
                    <button type="submit" class="btn btn-success" id="submitBtn">Submit Plan</button>
                </div>
            </div>
        </form>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- DYNAMIC LIST MANAGEMENT ---
            document.body.addEventListener('click', function(e) {
                // Generic handler for all "remove" buttons
                if (e.target.matches('.remove-item-btn')) {
                    e.target.closest('.input-group, .card').remove();
                }

                // Generic handler for simple "add" buttons (Itinerary, Sales Objectives)
                if (e.target.matches('.add-item-btn')) {
                    const targetContainerId = e.target.dataset.target;
                    const inputId = e.target.dataset.input;
                    const container = document.getElementById(targetContainerId);
                    const input = document.getElementById(inputId);
                    const value = input.value.trim();
                    if (value) {
                        const div = document.createElement('div');
                        div.className = 'input-group mb-2';
                        div.innerHTML = `
                            <span class="input-group-text">${container.children.length + 1}.</span>
                            <input type="text" class="form-control" value="${value}" disabled>
                            <button class="btn btn-outline-danger remove-item-btn" type="button">X</button>
                        `;
                        container.appendChild(div);
                        input.value = '';
                    }
                }
            });

            // Handler for "Add Current Collection"
            document.getElementById('add-current-collection-btn').addEventListener('click', function() {
                const container = document.getElementById('current-collections-container');
                const clientInput = document.getElementById('current-collection-client');
                const amountInput = document.getElementById('current-collection-amount');
                const client = clientInput.value.trim();
                const amount = amountInput.value.trim();
                if (client && amount) {
                    const div = document.createElement('div');
                    div.className = 'input-group mb-2 collection-item';
                    div.dataset.client = client;
                    div.dataset.amount = amount;
                    div.innerHTML = `
                        <input type="text" class="form-control" value="${client}" disabled>
                        <span class="input-group-text">₱</span>
                        <input type="number" class="form-control" value="${amount}" step="0.01" disabled>
                        <button class="btn btn-outline-danger remove-item-btn" type="button">X</button>
                    `;
                    container.appendChild(div);
                    clientInput.value = '';
                    amountInput.value = '';
                }
            });

            // Handler for "Add Overdue Collection"
            document.getElementById('add-overdue-collection-btn').addEventListener('click', function() {
                const container = document.getElementById('overdue-collections-container');
                const clientInput = document.getElementById('overdue-client');
                const siInput = document.getElementById('overdue-si');
                const dateInput = document.getElementById('overdue-date');
                const amountInput = document.getElementById('overdue-amount');
                
                const client = clientInput.value.trim();
                const si = siInput.value.trim();
                const date = dateInput.value;
                const amount = amountInput.value.trim();

                if (client && si && date && amount) {
                    const div = document.createElement('div');
                    div.className = 'card bg-light p-3 mb-2 overdue-collection-item';
                    div.dataset.client = client;
                    div.dataset.si = si;
                    div.dataset.date = date;
                    div.dataset.amount = amount;
                    div.innerHTML = `
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6>Overdue Target</h6>
                            <button class="btn btn-sm btn-danger remove-item-btn" type="button">Remove</button>
                        </div>
                        <input type="text" class="form-control mb-2" value="${client}" disabled>
                        <input type="text" class="form-control mb-2" value="${si}" disabled>
                        <input type="date" class="form-control mb-2" value="${date}" disabled>
                        <input type="number" class="form-control" value="${amount}" step="0.01" disabled>
                    `;
                    container.appendChild(div);
                    clientInput.value = '';
                    siInput.value = '';
                    dateInput.value = '';
                    amountInput.value = '';
                }
            });

            // --- AJAX FORM SUBMISSION ---
            const form = document.getElementById('dailyPlanForm');
            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                const submitBtn = document.getElementById('submitBtn');
                const notificationArea = document.getElementById('notification-area');
                
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Submitting...';
                notificationArea.innerHTML = '';

                // Gather data from all fields
                const planData = {
                    planDate: document.getElementById('planDate').value,
                    firstClientCall: document.getElementById('firstClientCall').value,
                    areasToVisit: document.getElementById('areasToVisit').value,
                    itinerary: Array.from(document.querySelectorAll('#itinerary-container .form-control')).map(input => input.value),
                    salesObjectives: Array.from(document.querySelectorAll('#sales-objectives-container .form-control')).map(input => ({ objective: input.value })),
                    targetCollections: {
                        current: Array.from(document.querySelectorAll('#current-collections-container .collection-item')).map(item => ({
                            client: item.dataset.client,
                            amount: item.dataset.amount
                        })),
                        overdue: Array.from(document.querySelectorAll('#overdue-collections-container .overdue-collection-item')).map(item => ({
                            client: item.dataset.client,
                            siDrNumber: item.dataset.si,
                            date: item.dataset.date,
                            amount: item.dataset.amount
                        }))
                    }
                };

                try {
                    const response = await fetch('/planning/daily', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                        body: JSON.stringify(planData)
                    });
                    
                    const result = await response.json();
                    
                    if (!response.ok) {
                        throw new Error(result.message || 'An unknown server error occurred.');
                    }
                    
                    notificationArea.innerHTML = `<div class="alert alert-success">${result.message} Redirecting...</div>`;
                    setTimeout(() => {
                        window.location.href = '/planning/my-plans';
                    }, 1500);

                } catch (error) {
                    notificationArea.innerHTML = `<div class="alert alert-danger">${error.message}</div>`;
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Submit Plan';
                }
            });
        });
    </script>
</body>
</html>
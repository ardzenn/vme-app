<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Call Plan - VME App</title>
    <%- include('partials/header-meta') %>
    <style>
        .card-body h5 {
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <%- include('partials/navbar') %>

    <main class="container my-5" style="max-width: 800px;">
        <header class="page-header">
            <div>
                <h1>Daily Call Plan</h1>
                <p class="text-muted">Outline your objectives and targets for the day.</p>
            </div>
        </header>

        <% if (locals.error_msg && error_msg.length > 0) { %>
            <div class="alert alert-danger"><%= error_msg %></div>
        <% } %>

        <form action="/planning/daily" method="POST">
            <div class="card">
                <div class="card-body">
                    <div class="mb-3">
                        <label for="planDate" class="form-label">Plan Date</label>
                        <input type="date" id="planDate" name="planDate" class="form-control" value="<%= planDate %>" required>
                    </div>
                    <div class="mb-3">
                        <label for="firstClientCall" class="form-label">First Client Call</label>
                        <input type="text" id="firstClientCall" name="firstClientCall" class="form-control" placeholder="e.g., Davao City Hall" value="<%= plan.firstClientCall || '' %>">
                    </div>
                    <div class="mb-4">
                        <label for="areasToVisit" class="form-label">Areas to Visit Today</label>
                        <input type="text" id="areasToVisit" name="areasToVisit" class="form-control" placeholder="e.g., Digos, Davao del Sur" value="<%= plan.areasToVisit || '' %>">
                    </div>

                    <!-- 1. Hospitals & Capitol to Visit -->
                    <h5 class="mt-4">1. Hospitals & Capitol to Visit</h5>
                    <div id="itinerary-container">
                        <% plan.itinerary.forEach((item, index) => { %>
                            <div class="input-group mb-2">
                                <span class="input-group-text"><%= index + 1 %>.</span>
                                <input type="text" name="itinerary[]" class="form-control" placeholder="Place Name" value="<%= item %>">
                                <button class="btn btn-outline-danger" type="button" onclick="this.parentElement.remove()">X</button>
                            </div>
                        <% }) %>
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="addItineraryItem()">+ Add Place</button>

                    <!-- 2. Sales Objectives -->
                    <h5 class="mt-4">2. Sales Objectives for the Day</h5>
                    <div id="sales-objectives-container">
                        <% plan.salesObjectives.forEach((obj, index) => { %>
                        <div class="input-group mb-2">
                             <input type="text" name="salesObjectives[<%= index %>][objective]" class="form-control" placeholder="Objective description" value="<%= obj.objective %>">
                             <button class="btn btn-outline-danger" type="button" onclick="this.parentElement.remove()">X</button>
                        </div>
                        <% }) %>
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="addSalesObjective()">+ Add Objective</button>

                    <!-- 3. Target Collections (Current) -->
                    <h5 class="mt-4">3. Target Collections for the Day (90 Days and Below)</h5>
                    <div id="current-collections-container">
                        <% plan.targetCollections.current.forEach((col, index) => { %>
                        <div class="input-group mb-2">
                            <input type="text" name="targetCollections[current][<%= index %>][client]" class="form-control" placeholder="Client Name" value="<%= col.client %>">
                            <span class="input-group-text">₱</span>
                            <input type="number" name="targetCollections[current][<%= index %>][amount]" class="form-control" placeholder="Amount" value="<%= col.amount %>" step="0.01">
                            <button class="btn btn-outline-danger" type="button" onclick="this.parentElement.remove()">X</button>
                        </div>
                        <% }) %>
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="addCurrentCollection()">+ Add Target</button>

                    <!-- 4. Target Collections (Overdue) -->
                    <h5 class="mt-4">4. Target Collections for Overdue Accounts</h5>
                    <div id="overdue-collections-container">
                         <% plan.targetCollections.overdue.forEach((col, index) => { %>
                         <div class="card bg-light p-3 mb-2">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h6>Overdue Target <%= index + 1 %></h6>
                                <button class="btn btn-sm btn-danger" type="button" onclick="this.closest('.card').remove()">Remove</button>
                            </div>
                            <input type="text" name="targetCollections[overdue][<%= index %>][client]" class="form-control mb-2" placeholder="Client Name" value="<%= col.client %>">
                            <input type="text" name="targetCollections[overdue][<%= index %>][siDrNumber]" class="form-control mb-2" placeholder="SI / DR Number" value="<%= col.siDrNumber %>">
                            <input type="date" name="targetCollections[overdue][<%= index %>][date]" class="form-control mb-2" value="<%= col.date ? new Date(col.date).toISOString().split('T')[0] : '' %>">
                            <input type="number" name="targetCollections[overdue][<%= index %>][amount]" class="form-control" placeholder="Amount" value="<%= col.amount %>" step="0.01">
                         </div>
                         <% }) %>
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="addOverdueCollection()">+ Add Overdue Target</button>
                </div>

                <div class="card-footer text-end">
                    <a href="/planning/my-plans" class="btn btn-secondary">Cancel</a>
                    <button type="submit" class="btn btn-success">Submit Plan</button>
                </div>
            </div>
        </form>
    </main>

    <script>
        function addItineraryItem() {
            const container = document.getElementById('itinerary-container');
            const index = container.children.length;
            const div = document.createElement('div');
            div.className = 'input-group mb-2';
            div.innerHTML = `
                <span class="input-group-text">${index + 1}.</span>
                <input type="text" name="itinerary[]" class="form-control" placeholder="Place Name">
                <button class="btn btn-outline-danger" type="button" onclick="this.parentElement.remove()">X</button>
            `;
            container.appendChild(div);
        }

        function addSalesObjective() {
            const container = document.getElementById('sales-objectives-container');
            const index = container.children.length;
            const div = document.createElement('div');
            div.className = 'input-group mb-2';
            div.innerHTML = `
                <input type="text" name="salesObjectives[${index}][objective]" class="form-control" placeholder="Objective description">
                <button class="btn btn-outline-danger" type="button" onclick="this.parentElement.remove()">X</button>
            `;
            container.appendChild(div);
        }

        function addCurrentCollection() {
            const container = document.getElementById('current-collections-container');
            const index = container.children.length;
            const div = document.createElement('div');
            div.className = 'input-group mb-2';
            div.innerHTML = `
                <input type="text" name="targetCollections[current][${index}][client]" class="form-control" placeholder="Client Name">
                <span class="input-group-text">₱</span>
                <input type="number" name="targetCollections[current][${index}][amount]" class="form-control" placeholder="Amount" step="0.01">
                <button class="btn btn-outline-danger" type="button" onclick="this.parentElement.remove()">X</button>
            `;
            container.appendChild(div);
        }

        function addOverdueCollection() {
            const container = document.getElementById('overdue-collections-container');
            const index = container.children.length;
            const div = document.createElement('div');
            div.className = 'card bg-light p-3 mb-2';
            div.innerHTML = `
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6>Overdue Target ${index + 1}</h6>
                    <button class="btn btn-sm btn-danger" type="button" onclick="this.closest('.card').remove()">Remove</button>
                </div>
                <input type="text" name="targetCollections[overdue][${index}][client]" class="form-control mb-2" placeholder="Client Name">
                <input type="text" name="targetCollections[overdue][${index}][siDrNumber]" class="form-control mb-2" placeholder="SI / DR Number">
                <input type="date" name="targetCollections[overdue][${index}][date]" class="form-control mb-2">
                <input type="number" name="targetCollections[overdue][${index}][amount]" class="form-control" placeholder="Amount" step="0.01">
            `;
            container.appendChild(div);
        }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Order - VME App</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="manifest" href="/manifest.json">
</head>
<body>
    <%- include('partials/navbar') %>
    <main style="padding: 2rem;">
        <div class="container" style="max-width: 900px;">
            <header class="page-header" style="padding-bottom: 1.5rem;">
                <div>
                    <h1 style="font-size: 1.875rem;">Book a New Order</h1>
                    <p style="margin: 0;">Fill in the details below to create a new sales order.</p>
                </div>
            </header>

            <div class="card">
                <!-- The form now needs enctype="multipart/form-data" to handle file uploads -->
                <form action="/orders/book" method="POST" id="bookOrderForm" enctype="multipart/form-data">
                    <div class="card-body">
                        <!-- User Info (Auto-filled) -->
                        <div class="row g-3 mb-4">
                            <div class="col-md-6">
                                <label class="form-label">Sales Representative</label>
                                <input type="text" class="form-control" value="<%= currentUser.firstName %> <%= currentUser.lastName %>" disabled>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Position</label>
                                <input type="text" class="form-control" value="<%= currentUser.role %>" disabled>
                            </div>
                        </div>

                        <!-- Customer Details -->
                        <h5 class="mb-3">Customer Details</h5>
                        <div class="row g-3 mb-4">
                            <div class="col-md-6">
                                <label class="form-label">Customer Name</label>
                                <input type="text" name="customerName" class="form-control" required>
                            </div>
                            <!-- NEW: Email Address Field -->
                            <div class="col-md-6">
                                <label class="form-label">Email Address</label>
                                <input type="email" name="email" class="form-control">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Contact Number</label>
                                <input type="text" name="contactNumber" class="form-control">
                            </div>
                             <div class="col-md-6">
                                <label class="form-label">Hospital/Clinic</label>
                                <input type="text" name="hospital" class="form-control">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Area</label>
                                <input type="text" name="area" class="form-control">
                            </div>
                        </div>

                        <!-- Products Section -->
                        <h5 class="mb-3">Products</h5>
                        <div id="products-container">
                            <!-- Product rows will be injected here by JS -->
                        </div>
                        <button type="button" id="add-product-btn" class="btn btn-outline-primary btn-sm mt-2">Add Product</button>

                        <hr class="my-4">

                        <!-- Notes & Attachment -->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Notes</label>
                                    <textarea name="note" class="form-control" rows="4"></textarea>
                                </div>
                                <!-- NEW: Attachment Field -->
                                <div class="mb-3">
                                    <label for="attachment" class="form-label">Attach Image (e.g., Purchase Order)</label>
                                    <input class="form-control" type="file" id="attachment" name="attachment" accept="image/*">
                                </div>
                            </div>
                            <div class="col-md-6 text-end">
                                <h4>Subtotal: <span id="subtotal-display">0.00</span></h4>
                                <input type="hidden" name="subtotal" id="subtotal-input" value="0">
                            </div>
                        </div>
                    </div>
                    <div class="card-footer d-flex justify-content-end">
                        <a href="/dashboard" class="btn btn-secondary me-2">Cancel</a>
                        <button type="submit" class="btn btn-primary">Submit Order</button>
                    </div>
                </form>
            </div>
        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const productsContainer = document.getElementById('products-container');
            const addProductBtn = document.getElementById('add-product-btn');
            const subtotalDisplay = document.getElementById('subtotal-display');
            const subtotalInput = document.getElementById('subtotal-input');
            let productIndex = 0;

            function addProductRow() {
                const productRow = document.createElement('div');
                productRow.classList.add('row', 'g-3', 'align-items-center', 'mb-2', 'product-row');
                productRow.innerHTML = `
                    <div class="col-md-5"><input type="text" name="products[${productIndex}][product]" class="form-control" placeholder="Product Name" required></div>
                    <div class="col-md-2"><input type="number" name="products[${productIndex}][quantity]" class="form-control quantity" placeholder="Qty" value="1" min="1" required></div>
                    <div class="col-md-2"><input type="number" name="products[${productIndex}][price]" class="form-control price" placeholder="Price" step="0.01" min="0" required></div>
                    <div class="col-md-2"><span class="total-display fw-bold">₱0.00</span><input type="hidden" name="products[${productIndex}][total]" class="total-input"></div>
                    <div class="col-md-1"><button type="button" class="btn btn-danger btn-sm remove-product-btn">X</button></div>
                `;
                productsContainer.appendChild(productRow);
                productIndex++;
            }

            function updateTotals() {
                let currentSubtotal = 0;
                document.querySelectorAll('.product-row').forEach(row => {
                    const quantity = parseFloat(row.querySelector('.quantity').value) || 0;
                    const price = parseFloat(row.querySelector('.price').value) || 0;
                    const total = quantity * price;
                    row.querySelector('.total-display').innerText = `₱${total.toFixed(2)}`;
                    row.querySelector('.total-input').value = total.toFixed(2);
                    currentSubtotal += total;
                });
                subtotalDisplay.innerText = `₱${currentSubtotal.toLocaleString('en-PH', { style: 'currency', currency: 'PHP' })}`;
                subtotalInput.value = currentSubtotal.toFixed(2);
            }

            addProductBtn.addEventListener('click', addProductRow);
            productsContainer.addEventListener('input', updateTotals);
            productsContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('remove-product-btn')) {
                    e.target.closest('.product-row').remove();
                    updateTotals();
                }
            });
            addProductRow();
        });
    </script>
</body>
</html>
